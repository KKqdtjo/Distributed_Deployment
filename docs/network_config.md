# 网络配置指南

本文档详细介绍华为云ECS上DeepSeek模型分布式部署的网络配置。

## 目录

- [网络架构概述](#网络架构概述)
- [VPC配置](#VPC配置)
- [安全组配置](#安全组配置)
- [负载均衡配置](#负载均衡配置)
- [弹性IP配置](#弹性IP配置)
- [网络性能优化](#网络性能优化)

## 网络架构概述

分布式部署DeepSeek模型的网络架构如下：

```
                          Internet
                              |
                              | (EIP)
                              V
                       +-------------+
                       | 负载均衡器  |
                       +-------------+
                           /    \
                          /      \
                         /        \
                        V          V
                +-----------+  +-----------+
                | 前端服务器1 |  | 前端服务器2 |
                +-----------+  +-----------+
                        \         /
                         \       /
                          V     V
                     +--------------+
                     |   Ray头节点   |
                     +--------------+
                       /   |    \
                      /    |     \
                     V     V      V
               +--------+ +--------+ +--------+
               |工作节点1| |工作节点2| |   ...  |
               +--------+ +--------+ +--------+
                    |          |         |
                    V          V         V
               +---------------------------+
               |      共享存储 (OBS)       |
               +---------------------------+
```

## VPC配置

1. 创建VPC (Virtual Private Cloud)：

```
华为云管理控制台 -> 网络 -> 虚拟私有云 -> 创建虚拟私有云
```

配置参数：

- 名称：`deepseek-vpc`
- IPv4网段：`192.168.0.0/16`（可根据需求调整）
- 默认子网：启用

2. 创建子网：

```
华为云管理控制台 -> 网络 -> 虚拟私有云 -> 子网 -> 创建子网
```

创建以下子网：

| 子网名称 | 子网网段 | 用途 |
|---------|---------|-----|
| frontend-subnet | 192.168.1.0/24 | 前端服务器和负载均衡器 |
| compute-subnet | 192.168.2.0/24 | Ray头节点和工作节点 |
| storage-subnet | 192.168.3.0/24 | Redis集群和共享存储 |

3. 配置路由表：

确保VPC内部的子网之间可以相互通信。默认情况下，同一VPC内的子网可以相互访问，无需额外配置。

## 安全组配置

为不同类型的服务器创建不同的安全组并配置相应的规则：

1. 负载均衡器和前端服务器安全组：

```
华为云管理控制台 -> 网络 -> 安全组 -> 创建安全组
```

配置以下入站规则：

| 协议 | 端口范围 | 源地址 | 描述 |
|-----|---------|-------|-----|
| TCP | 80, 443 | 0.0.0.0/0 | HTTP/HTTPS流量 |
| TCP | 22 | 管理IP范围 | SSH访问（仅限管理IP） |
| TCP | 8000 | 192.168.0.0/16 | API服务（内部访问） |

2. Ray头节点安全组：

配置以下入站规则：

| 协议 | 端口范围 | 源地址 | 描述 |
|-----|---------|-------|-----|
| TCP | 8265 | 192.168.0.0/16 | Ray头节点服务 |
| TCP | 6379-6381 | 192.168.0.0/16 | Redis端口 |
| TCP | 8000-8100 | 192.168.0.0/16 | API和服务端口 |
| TCP | 22 | 管理IP范围 | SSH访问（仅限管理IP） |
| TCP | 10001-10010 | 192.168.0.0/16 | Ray内部通信 |
| UDP | 10001-10010 | 192.168.0.0/16 | Ray内部通信 |

3. Ray工作节点安全组：

配置以下入站规则：

| 协议 | 端口范围 | 源地址 | 描述 |
|-----|---------|-------|-----|
| TCP | 8265 | 192.168.0.0/16 | Ray工作节点服务 |
| TCP | 22 | 管理IP范围 | SSH访问（仅限管理IP） |
| TCP | 10001-19999 | 192.168.0.0/16 | Ray内部通信 |
| UDP | 10001-19999 | 192.168.0.0/16 | Ray内部通信 |

4. Redis和存储节点安全组：

配置以下入站规则：

| 协议 | 端口范围 | 源地址 | 描述 |
|-----|---------|-------|-----|
| TCP | 6379-6381 | 192.168.0.0/16 | Redis端口 |
| TCP | 22 | 管理IP范围 | SSH访问（仅限管理IP） |
| TCP | 2049 | 192.168.0.0/16 | NFS（如果使用） |

## 负载均衡配置

1. 创建负载均衡器：

```
华为云管理控制台 -> 网络 -> 弹性负载均衡 -> 创建负载均衡器
```

配置参数：

- 类型：公网负载均衡器
- 规格：根据预期流量选择适当规格
- 子网：frontend-subnet
- 公网IP：新申请或绑定已有EIP

2. 配置监听器：

创建HTTP监听器（端口80）和HTTPS监听器（端口443）：

```
负载均衡器 -> 监听器 -> 添加监听器
```

HTTPS监听器需上传SSL证书。

3. 创建后端服务器组：

```
负载均衡器 -> 后端服务器组 -> 创建后端服务器组
```

配置健康检查：

- 协议：HTTP
- 路径：/health
- 端口：8000
- 检查间隔：5秒
- 超时时间：3秒
- 健康阈值：3次
- 不健康阈值：3次

4. 添加前端服务器到后端服务器组：

```
后端服务器组 -> 添加后端服务器
```

选择前端服务器，配置端口为8000。

## 弹性IP配置

1. 为负载均衡器分配弹性IP（EIP）：

```
华为云管理控制台 -> 网络 -> 弹性公网IP -> 申请弹性公网IP
```

选择适当的带宽和计费模式。

2. 为Ray头节点分配弹性IP（便于远程管理）：

同样申请一个弹性IP，并绑定到Ray头节点。

## 网络性能优化

1. 启用增强网络功能：

在创建ECS实例时，选择支持SR-IOV的实例类型并启用增强网络功能。

2. 配置弹性网卡队列（适用于高性能需求）：

```bash
# 安装ethtool工具
sudo apt-get install ethtool

# 查看当前网卡队列设置
ethtool -l eth0

# 设置发送和接收队列数量（假设最大支持16个队列）
sudo ethtool -L eth0 combined 16
```

3. 优化TCP/IP协议栈参数：

```bash
# 编辑/etc/sysctl.conf文件
sudo vim /etc/sysctl.conf

# 添加以下配置
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_mem = 16777216 16777216 16777216
net.core.netdev_max_backlog = 30000
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_mtu_probing = 1

# 应用配置
sudo sysctl -p
```

4. 使用跨节点高速网络（如果可用）：

在创建ECS实例时，选择支持RDMA或高速网络的实例类型，以提高节点间通信性能。

## 网络监控

配置网络监控，确保及时发现潜在问题：

1. 启用华为云云监控服务，监控网络流量和延迟等指标。

2. 在每个节点上安装性能监控工具：

```bash
# 安装监控工具
sudo apt-get install -y iftop nethogs nload

# 使用iftop监控网络流量
sudo iftop -i eth0
```

至此，您已完成DeepSeek模型分布式部署的网络配置。这些配置将确保集群内部通信高效，同时提供安全可靠的外部访问。
